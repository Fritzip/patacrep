{% extends "patacrep/base_template.html" %}
{% load static %}

{% block pagetitle %}
  Index {% if user.is_superuser %}<span>{{ nb_chords }} chords</span><span>{{ nb_warn }} warnings</span>{% endif %}
{% endblock %}

{% block navbar_extra %}
<form class="form-inline my-2 my-lg-0">
  <input id="searchbar" class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
</form>
{% endblock navbar_extra %}

{% block options %}
{% endblock options %}

{% block content %}
<div class="content list-group">
  {% for artist, chords in dartist.items %}
    <span class="list-group-item list-group-item-secondary font-weight-bold artist" id="{{ artist | slugify }}">{{ artist }}</span>
    {% for chord in chords %}
      <a href="{% url 'patacrep:detail' chord.chord_id %}" class="list-group-item list-group-item-action chord {% if forloop.last %}bottom-rounded{%endif%} {% if chord.warning_lines and user.is_superuser %} list-group-item-warning {% endif %}" data-artist="{{artist | slugify }}">
          <span class="mx-1">{{ chord.title }}</span>
          <span class="badge badge-secondary">{% if chord.in_project and user.is_superuser %}<i class="icon fas fa-hammer checked"></i>{% endif %}{% if chord.favorite and user.is_superuser %}<i class="icon fas fa-star checked"></i>{% endif %}</span>
      </a>
    {% endfor %}
  {% endfor %}
</div>
{% endblock %}


{% block js %}
{{block.super}}
<script>
  var NEED_BREAK_RM = true;

  $(document).ready(function(){
    $("#searchbar").on('input', function() {
      var search = $(this).val();
      $( ".artist" ).each(function() {
        var $artist = $(this);
        var resartist = $artist.text().match(new RegExp(search, 'i'));
        if(resartist == null) { // doesn't match the artist
          var at_least_one = false;
          $( '.chord[data-artist="'+$artist.attr('id')+'"]').each(function() { // check for match in chords of the artist
            var $chord = $(this);
            var reschord = $chord.text().match(new RegExp(search, 'i'));
            if (reschord == null) { // chord doesn't match -> hide
              $chord.hide();
            } else { // chord match -> show and do not hide artist
              at_least_one = true;
              $chord.show();
            }
          });
          if (at_least_one) {
            $artist.show();
          } else {
            $artist.hide();
          }
        } else { // match the artist, show every chord
          $artist.show();
          $( '.chord[data-artist="'+$artist.attr('id')+'"]').each(function() {
            $(this).show();
          });
        }
      });
      if(!$(this).val()) {
        specialWrap('.list-group-item');
      } else if (NEED_BREAK_RM) {
        $(".break").remove();
        NEED_BREAK_RM = false;
      }
    });

    function wrap_artist_and_first_chord() {
      $('.artist').each(function(){
        if ($(this).next('.chord').next().hasClass('artist')) {
          $(this).next('.chord').add(this).wrapAll('<span>');
        } else {
          $(this).next('.chord').addClass('not-last').add(this).wrapAll('<span class="artist-header">');
        }
      });      
    }

    // $("#searchbar").on('focus', function() {
    //   $('.artist').each( function () {
    //     if ($(this).parent().hasClass('artist-header')) {
    //       $(this).unwrap();
    //     }
    //   });  
    // });

    // $("#searchbar").on('blur', function() {
    //   if ($(this).val() == "") {
    //     wrap_artist_and_first_chord();
    //   }
    // }); 

    // wrap_artist_and_first_chord();

    function anchor_highlight(artist) {
        var $artist = $('.artist[id="'+artist+'"]');
        var $chord = $( '.chord[data-artist="'+artist+'"]');
        var scroll_amount = $artist.offset().left - 5;
        if ($('.sidebar').is(":visible")) {
          scroll_amount -= $('.sidebar').width();
        }
        $('.content').stop().animate({
            scrollLeft: '+='+scroll_amount
        }, 600);

        $artist.addClass('anchor');
        $chord.each(function() {
          $(this).addClass('anchor');
        });

        setTimeout( function() {
          $chord.each(function() {
            $(this).removeClass('anchor');
          });
          $artist.removeClass('anchor');
        }, 2000);
    }

    var hash = window.location.hash.substr(1);
    if (hash) {
      anchor_highlight(hash);
    }

    $(".artist-list").bind('click',function(event){
        var artist = $(this).data("artist");
        anchor_highlight(artist);
    //     event.preventDefault();
    });
  });


  function specialWrap(className) {
    $(".break").remove();
    var prevItem = {};
    var currItem = {};
    $(className+":visible").each(function() {
      currItem = this.getBoundingClientRect();
      if (!prevItem || prevItem.top >= currItem.top) {
        if ($(this).prev().hasClass('artist')) {
          $( "<span class='break'></span>" ).insertBefore( $(this).prev() );
        }
      }
      prevItem = currItem;
    });
    NEED_BREAK_RM = true;
  }

  window.onload = function(event){
    specialWrap('.list-group-item');
  };
  window.onresize = function() {
    specialWrap('.list-group-item');
  };
</script>
{% endblock %}
